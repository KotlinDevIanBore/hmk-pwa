generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String           @id @default(cuid())
  phoneNumber       String           @unique
  email             String?
  phoneVerified     Boolean          @default(false)
  pin               String?
  pinHash           String?
  role              UserRole
  disabilityType    DisabilityType?
  firstName         String?
  lastName          String?
  dateOfBirth       DateTime?
  age               Int?
  gender            Gender?
  county            String?
  subCounty         String?
  ward              String?
  village           String?
  idType            IdType?
  idNumber          String?
  nationalId        String?          @unique
  profileComplete   Boolean          @default(false)
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  lastLogin         DateTime?
  isActive          Boolean          @default(true)
  preferredLanguage String           @default("en")
  appointments      Appointment[]
  assessments       Assessment[]
  beneficiaries     Beneficiary[]    @relation("CaregiverBeneficiaries")
  caregivers        Beneficiary[]    @relation("PWDBeneficiary")
  feedback          Feedback[]
  otpLogs           OtpLog[]
  serviceRequests   ServiceRequest[]
  smsLogs           SmsLog[]

  @@index([phoneNumber])
  @@index([role])
  @@index([isActive])
}

model OtpLog {
  id          String    @id @default(cuid())
  userId      String
  phoneNumber String
  otp         String
  purpose     String
  isUsed      Boolean   @default(false)
  expiresAt   DateTime
  createdAt   DateTime  @default(now())
  usedAt      DateTime?
  ipAddress   String?
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([phoneNumber])
  @@index([expiresAt])
  @@index([isUsed])
}

model Beneficiary {
  id           String       @id @default(cuid())
  caregiverId  String
  pwdId        String
  relationship Relationship
  isVerified   Boolean      @default(false)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  caregiver    User         @relation("CaregiverBeneficiaries", fields: [caregiverId], references: [id], onDelete: Cascade)
  pwd          User         @relation("PWDBeneficiary", fields: [pwdId], references: [id], onDelete: Cascade)

  @@unique([caregiverId, pwdId])
  @@index([caregiverId])
  @@index([pwdId])
}

model Appointment {
  id                 String                  @id @default(cuid())
  userId             String
  appointmentDate    DateTime
  appointmentTime    String
  locationType       AppointmentLocationType
  location           String?
  outreachLocationId String?
  purpose            String
  status             AppointmentStatus       @default(PENDING)
  serviceFee         Float?
  ageGroup           String?
  notes              String?
  reminderSent       Boolean                 @default(false)
  reminderSentAt     DateTime?
  cancelledReason    String?
  createdAt          DateTime                @default(now())
  updatedAt          DateTime                @updatedAt
  outreachLocation   OutreachLocation?       @relation(fields: [outreachLocationId], references: [id])
  user               User                    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([appointmentDate])
  @@index([status])
  @@index([locationType])
  @@index([appointmentDate, appointmentTime, locationType])
}

model AppointmentConfig {
  id             String                  @id @default(cuid())
  date           DateTime                @unique
  locationType   AppointmentLocationType
  slotsAvailable Int?
  slotsUnder15   Int?
  slotsOver15    Int?
  isAvailable    Boolean                 @default(true)
  notes          String?
  createdAt      DateTime                @default(now())
  updatedAt      DateTime                @updatedAt

  @@index([date, locationType])
}

model MobilityDevice {
  id             String   @id @default(cuid())
  name           String
  description    String
  category       String
  imageUrl       String?
  price          Float?
  availability   Boolean  @default(true)
  specifications Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([category])
  @@index([availability])
}

model ServiceRequest {
  id          String        @id @default(cuid())
  userId      String
  serviceType ServiceType
  title       String
  description String
  status      ServiceStatus @default(PENDING)
  priority    String        @default("medium")
  assignedTo  String?
  notes       String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  completedAt DateTime?
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([serviceType])
  @@index([status])
}

model Assessment {
  id              String           @id @default(cuid())
  userId          String
  status          AssessmentStatus @default(DRAFT)
  responses       Json
  score           Int?
  recommendations String?
  assessedBy      String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  submittedAt     DateTime?
  reviewedAt      DateTime?
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
}

model OutreachLocation {
  id           String        @id @default(cuid())
  name         String
  county       String
  subCounty    String?
  ward         String?
  description  String?
  address      String?
  coordinates  Json?
  contactName  String?
  contactPhone String?
  isActive     Boolean       @default(true)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  appointments Appointment[]

  @@index([county])
  @@index([isActive])
}

model AdminUser {
  id           String        @id @default(cuid())
  email        String        @unique
  passwordHash String
  role         AdminRole     @default(SUPPORT)
  firstName    String
  lastName     String
  isActive     Boolean       @default(true)
  lastLogin    DateTime?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  invites      AdminInvite[]

  @@index([email])
  @@index([role])
  @@index([isActive])
}

model AdminInvite {
  id        String    @id @default(cuid())
  email     String
  token     String    @unique
  role      AdminRole @default(SUPPORT)
  invitedBy String
  isUsed    Boolean   @default(false)
  expiresAt DateTime
  createdAt DateTime  @default(now())
  usedAt    DateTime?
  inviter   AdminUser @relation(fields: [invitedBy], references: [id], onDelete: Cascade)

  @@index([email])
  @@index([token])
  @@index([isUsed])
  @@index([expiresAt])
}

model SmsLog {
  id          String    @id @default(cuid())
  userId      String?
  phoneNumber String
  message     String
  purpose     String
  status      String    @default("sent")
  provider    String    @default("simulated")
  cost        Float?
  createdAt   DateTime  @default(now())
  deliveredAt DateTime?
  user        User?     @relation(fields: [userId], references: [id])

  @@index([phoneNumber])
  @@index([purpose])
  @@index([createdAt])
}

model Feedback {
  id         String   @id @default(cuid())
  userId     String?
  rating     Int?
  category   String?
  message    String
  isResolved Boolean  @default(false)
  response   String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  user       User?    @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([category])
  @@index([isResolved])
}

model UssdCallback {
  id          String   @id @default(cuid())
  sessionId   String   @unique
  phoneNumber String
  serviceCode String
  text        String
  response    String?
  level       Int      @default(0)
  isComplete  Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([sessionId])
  @@index([phoneNumber])
  @@index([createdAt])
}

enum UserRole {
  PWD
  CAREGIVER
}

enum DisabilityType {
  MOBILITY
  VISUAL
  HEARING
  COGNITIVE
  MULTIPLE
  OTHER
}

enum Gender {
  MALE
  FEMALE
  OTHER
  PREFER_NOT_TO_SAY
}

enum IdType {
  NATIONAL_ID
  PASSPORT
  BIRTH_CERTIFICATE
  NCPWD
}

enum Relationship {
  PARENT
  CHILD
  SPOUSE
  SIBLING
  GUARDIAN
  OTHER
}

enum AppointmentStatus {
  PENDING
  CONFIRMED
  RESCHEDULED
  CHECKED_IN
  CHECKED_OUT
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum AppointmentLocationType {
  RESOURCE_CENTER
  OUTREACH
}

enum ServiceType {
  OPERATIONAL
  SPIRITUAL
}

enum ServiceStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum AdminRole {
  SUPER_ADMIN
  ADMIN
  MODERATOR
  SUPPORT
}

enum AssessmentStatus {
  DRAFT
  SUBMITTED
  REVIEWED
  APPROVED
}
